A note on a PDE approach to option pricing
under xVA

arXiv:2105.00051v1 [q-fin.RM] 30 Apr 2021

Falko Baustian1 , Martin Fencl2 , Jan Pospíšil∗2 , and Vladimír Švígler2
1

Department of Mathematics, University of Rostock, Ulmenstrasse 69, 18057 Rostock, Germany
2
NTIS - New Technologies for the Information Society, Faculty of Applied Sciences,
University of West Bohemia, Univerzitní 2732/8, 301 00 Plzeň, Czech Republic,

Received May 4, 2021
Abstract
In this paper we study partial differential equations (PDEs) that can be used to model value
adjustments. Different value adjustments denoted generally as xVA are nowadays added to
the risk-free financial derivative values and the PDE approach allows their easy incorporation.
The aim of this paper is to show how to solve the PDE analytically in the Black-Scholes setting
to get new semi-closed formulas that we compare to the widely used Monte-Carlo simulations
and to the numerical solutions of the PDE. Particular example of collateral taken as the values
from the past will be of interest.

Keywords: value adjustment; PDE; collateral; Monte-Carlo simulation
MSC classification: 91G20; 91B70; 91G40
JEL classification: G12; C63

Contents
1 Introduction

2

2 Preliminaries

3

3 Methodology
3.1 Solution by transformation to heat equation . . . . . . . . . .
3.2 Non-negative payoffs . . . . . . . . . . . . . . . . . . . . . . .
3.3 Boundary conditions . . . . . . . . . . . . . . . . . . . . . . .
3.4 Numerical solution using finite differences . . . . . . . . . . .
3.5 Numerical solution using the transformation to heat equation
3.6 Numerical solution using the Monte-Carlo method . . . . . .

.
.
.
.
.
.

5
5
6
7
8
9
10

4 Numerical results
4.1 Un-collateralized contract, X = 0 . . . . . . . . . . . . . . . . . . . . . . . . . . . .
4.2 Collateral as the delayed value, X = V (t − t0 , S(t − t0 )) . . . . . . . . . . . . . . .

11
11
11

5 Conclusion

13

∗ Corresponding

author, honik@kma.zcu.cz

1

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

.
.
.
.
.
.

1

Introduction

The famous Black-Scholes model for option pricing in an arbitrage-free environment was introduced
in 1973 by Black and Scholes (1973) and Merton (1973). The pioneering model was very popular
in the beginning and widely used by practitioners. One of the basic assumptions of the BlackScholes model is that the volatility of the underlying asset is constant. This hypothesis was later
discarded after Rubinstein (1985) observed that the real-market prices of out-of-the-money call
options with short maturity were significantly higher than the predictions of the model. Hull and
White (1987) introduced a model with stochastic volatility to fix this issue. The stock market
crash of October 1987 with the infamous Black Monday permanently changed the shape of the
volatility surface, see (Hull, 2009, Chapter 18.3). After the crash the implied volatility developed
the marked volatility smile as observed today that Rubinstein (1994) explained with the fear
of traders regarding the possibility of a similar event. As a consequence, stochastic volatility
models by Hull and White (1987), Stein and Stein (1991), Heston (1993), and others became
the standard in option pricing. The financial crisis that started in 2007 substantially changed
the rules for derivative pricing again. The possibility to borrow and lend any amount of money
at a risk-free interest rate is a crucial assumption of all the above mentioned models since its
standardly used in the hedging arguments for the price valuation of the options. As the crisis
culminated in the bankruptcy of Lehman Brothers and other big financial entities this conjecture
became obsolete. Since the default of a trading partner is not in the scope of the classic option
pricing models the traders had to react to this shortage in the models and included a collateral
against default in many trades. Both parties of a contract have to consider the potential default
of the counterparty. The traders respond to this bilateral counterparty risk with credit value
adjustments (CVA), Sorenson and Bollier (1994) and Jarrow and Turnbull (1995), to have a
collateral against default of the counterparty. The corresponding collateral of the counterparty,
e.g., a bank, is covered by a debit value adjustment (DVA), Duffie and Huang (1996). In addition
to this adjustments, derivative contracts can also contain a collateral, also called a collateral
value adjustment (COLVA), regulated by the credit support annex (CSA). For more details on
risk management see Hull (2018). Convexity adjustments that describe the differences between
the prices of collateralized and non-collateralized derivatives were studied by Piterbarg (2010).
Funding cost adjustments (FCA) are other common price adjustments that traders use to include
funding cost in the price of the contract. According to Burgard and Kjaer (2011a) and Hull and
White (2012) FCA have no theoretical basis. Since traders use them anyway Hull and White
(2014) studied the adjustments with focus on their practical realization. There exist also other
types of adjustments like capital value adjustments (KVA), margin value adjustments (MVA), and
liquidity value adjustments (LVA) but we will restrict ourselves just to CVA, DVA, and FCA. The
various adjustments to the value of the derivative are subsumed as xVA. A comprehensive guide
to xVA is the book by Gregory (2020).
In analogy to the Black-Scholes approach, Burgard and Kjaer (2011b) derived a partial differential equation (PDE) for the adjusted derivative price under bilateral counterparty risk and
funding costs. The partial differential equation is linear if the mark-to-market value at default is
considered to be the non-default value of the derivative and nonlinear if the mark-to-market value
is given by the adjusted value of the derivative with all value adjustments. The latter case is less
meaningful from the practitioner's point of view since the close out is based in the risk-free markto-market for contracts that follow the 2002 ISDA Master Agreement1 . Hence, we will study the
linear partial differential equation introduced in Burgard and Kjaer (2013) which takes collaterals
into account.
Value adjustments are normally applied to portfolios with various derivatives. Nevertheless, we
consider a single option contract to analyze the influence of the different adjustments. The macro
view, i.e., the homogeneous cost view for the whole portfolio, essentially follows from the micro
view of single contracts. We derive the analytic solution of the PDE of Burgard and Kjaer (2013),
obtain a semi-closed pricing formula for the value adjustments, and compare the formula to widely
1 available

online at https://www.isda.org/book/2002-isda-master-agreement-english/ [cit. 2019-09-12].

2

used Monte-Carlo simulations and numerical solutions of the partial differential equations as in
Arregui, Salvador, and Vázquez (2017) and Arregui, Salvador, Ševčovič, and Vázquez (2018). The
problem has recently been studied for the Heston model in Salvador and Oosterlee (2021).
The paper is structured in the following way. We introduce the PDE for the correction between
the adjusted price with xVA and the risk-free price of a derivative contract and we discuss various
collaterals in Section 2. In Section 3, we introduce the pricing formula and give details on the
numerical schemes, before numerical results are presented in Section 4. We conclude in Section 5.

2

Preliminaries

We consider a generic derivative contract (e.g. option), possibly collateralized, between an issuer
B and a counterparty C, with an economic value V̌ that incorporates the risk of default of counterparty and issuer and any net funding costs the issuer may encounter prior to own default. We
are mainly interested in the correction U = V̌ − V to the risk-free Black-Scholes price V . Using
the Black-Scholes PDE for V one can derive (Burgard and Kjaer, 2013) the corresponding PDE
for U .
Let A be the standard Black-Scholes operator
A=

∂
1 2 2 ∂2
+ (qS − γS )S
σ S
,
2
∂S 2
∂S

where σ > 0 is the constant volatility and qS − γS is the effective financing rate of the market
factor hedge S. We will study the following final value problem for function U (t, S)

 ∂U (t, S) + AU (t, S) − (r + λ + λ )U (t, S) = f (V (t, S)),
B
C
∂t

U (T, S) = 0,

for t ∈ [0, T ), S ≥ 0,

(1)

for S ≥ 0.

where the inhomogeneity f has the form

f = fCVA + fDVA + fFCA + fCOLVA ,
fCVA = −λC (gC − V ),

fDVA = −λB (gB − V ),
fFCA = λB * εh ,

fCOLVA = sX * X,

with constants λB , λC , sX and the hedge error εh described below. Here, λB , λC are the default
intensities of the counterparties, εh describes the size of the hedge error, and sX is the difference
between the collateral rate and the risk-free rate. X denotes the collateral and we have
gC = RC (V − X)+ − (V − X)− + X,
gB = (V − X)+ − RB (V − X)− + X,

where RB , RC ∈ [0, 1] are the recovery rates of the derivative position. For this regular bilateral
close-out the hedge error εh becomes
εh = (1 − RB )(V − X)+ .

(2)

The positive and negative part of a function φ are defined as φ+ = max(φ, 0) and φ− =
max(−φ, 0), respectively. We remark that Burgard and Kjaer (2013) use the definition min(φ, 0)
for the negative part resulting in slightly different equations.

3

We are interested in different standard types of collaterals. For un-collateralized derivative contracts, we have X = 0 and the terms fCVA , fDVA and fFCA simplify to
fCVA = λC (1 − RC )V + ,

fDVA = −λB (1 − RB )V − ,

fFCA = λB (1 − RB )V + .

In one-way CSA, the issuer posts collateral provided that the risk-free value is out-of-the-money.
That corresponds to X = −V − and we get
fCVA = λC (1 − RC )V + ,

fDVA = 0,

fFCA = λB (1 − RB )V + .

For gold-plated two-way CSA with collateral X = V there are no CVA, DVA, and FCA. If the
collateral rate equals the risk-free rate then the term fCOLVA vanishes and the adjusted price V̌
of a two-way CSA becomes the risk-less price V .
In real world situations, there is most likely a collateral that depends on V non-smoothly,
non-linearly or even discontinuously. For further reading about these dependencies we refer the
reader for example to ISDA: Legal Guidelines for Smart Derivatives Contracts: Collateral 2 .
A popular choice for a collateral among practitioners is the value from the previous day, i.e. in
more general case X = V (t − t0 , S). With the notation ∆t V = V (t, S) − V (t − t0 , S) we obtain
fCVA = −λC (RC (∆t V )+ − (∆t V )− − V (t − t0 , S)),

fDVA = −λB ((∆t V )+ − RB (∆t V )− − V (t − t0 , S)),
fFCA = λB (1 − RB )(∆t V )+ ,

for this collateral. Typically t denotes the current time, t0 = 1/252 represents one business day
and hence S(t − t0 ) is the value of the underlying asset price from the previous day. If V is the
Black-Scholes call option price, we have that
V (t − t0 , S(t − t0 )) = N (d1 (t − t0 , S(t − t0 )))S(t − t0 ) + Ke−r(T −t−t0 ) N (d2 (t − t0 , S(t − t0 )), (3)
where N (*) is the standard normal CDF and




1
1
x
d1,2 (s, x) = √
+ r ± σ 2 (T − s) .
ln
K
2
σ T −s
Applying the Feynman-Kac Theorem to PDE (1) gives us (Burgard and Kjaer, 2013) the
semi-closed solution in the form
U = UCVA + UDVA + UFCA + UCOLVA ,

(4)

with
Z

T

UCVA = −

Z

T

UDVA = −

T

UFCA = −

Z

T

UCOLVA = −

Z

λC (u)Dr+λB +λC (t, u)Et [V (u) − gC (V (u), X(u))] du,

t

λB (u)Dr+λB +λC (t, u)Et [V (u) − gB (V (u), X(u))] du,

t

λB (u)Dr+λB +λC (t, u)Et [εh (u)] du,

t

sX Dr+λB +λC (t, u)Et [X(u)] du,

t

 Ru
where Dr̂ (t, u) = exp − t r̂(v) dv is the discount factor between t and u for a rate r̂. The
measure of the expectations in these equations is such that S drifts at rate (qS − γS ). The sum of
DVA and FCA is sometimes referred to as funding valuation adjustments (FVA).
2 available online at https://www.isda.org/2019/09/12/legal-guidelines-for-smart-derivatives-contracts-collateral/
[cit. 2019-09-12].

4

3

Methodology

In this section we present our main results, in particular we show how to analytically solve the
corresponding PDE by a transformation to the heat equation and present a direct relation between
the correction and the risk-less price for certain contracts with non-negative payoff. We discuss
the boundary conditions for the numerical schemes and provide details on the numerics of all
three used approaches: finite differences, the semi-closed solution formula, and the Monte-Carlo
method.
We perform the standardly used change of variables to the time till maturity and the logarithm
of the stock price
τ = T − t and x = ln S,
(5)

and introduce new functions u(τ, x) ∼
= U (t, S) and v(τ, x) ∼
= V (t, S). After applying (5) to the
PDE (1) we get


∂u
1
∂u
1 ∂2u
= σ 2 2 + qS − γS − σ 2
− (r + λB + λC )u − f.
∂τ
2 ∂x
2
∂x
If we set

1
ρ = qS − γS − σ 2
2
to simplify the notation then we can write the initial value problem for the correction u(τ, x) as

∂u
1 ∂2u
∂u

= σ2 2 + ρ
− (r + λB + λC )u − f,
for τ ∈ (0, T ], x ∈ R,
(6)
∂τ
2 ∂x
∂x

u(0, x) = 0,
for x ∈ R.

The PDE (6) is parabolic and has a unique weak solution (Evans, 2010).

3.1

Solution by transformation to heat equation

Black and Scholes obtained their famous formula by transforming the PDE to the homogeneous
heat equation from physics. If we want to get a heat equation from (6), we have to perform
successive transformations.
We start by introducing ũ(τ, x) = e(r+λB +λC )τ u(τ, x) to simplify the PDE (6) to
∂ ũ
∂ ũ
1 ∂ 2 ũ
= σ2 2 + ρ
− f * e(r+λB +λC )τ .
∂τ
2 ∂x
∂x
 ̃(τ, x) = ũ(τ, x − ρτ ) to obtain the non-homogeneous heat equation
Next, we use a suitable shift ũ
 ̃
 ̃
1 ∂ 2 ũ
∂ũ
= σ 2 2 − f * e(r+λB +λC )τ .
∂τ
2 ∂x
 ̃(0, x) = u(0, x) = 0 for all x ∈ R and we can write the solution of (7) as
We observe that ũ


Z τ Z ∞
(z−x)2
1
−

 ̃(τ, x) = −
q
ũ
e 2σ2 (τ −s) * f (v(s, z)) dz  e(r+λB +λC )s ds.
1
2
0
−∞
4π 2 σ (τ − s)
We perform one more substitution

z−x
y=p
2σ 2 (τ − s)

to have the solution in the form

Z τ Z ∞
p
2
1
 ̃(τ, x) = − √
e−y * f (v(s, x + 2σ 2 (τ − s)y)) dy e(r+λB +λC )s ds.
ũ
π 0
−∞
5

(7)

Finally, we apply the inverse substitutions to obtain the formula for the solution of (6) in terms
of the original variables

Z τ Z ∞
p
1
−y 2
e
* f (v(s, x + ρτ + 2(τ − s)σy)) dy e−(r+λB +λC )(τ −s) ds. (8)
u(τ, x) = − √
π 0
−∞
Remark 3.1. Another representation of the same solution can be obtained by means of the Fourier
transform
Z ∞
u(τ, x)e−ikx dx,
û(τ, k) := F [u(τ, x)] =
−∞
Z ∞
ˆ
f (τ, k) := F [f (v(τ, x))] =
f (v(τ, x))e−ikx dx,
−∞

where i denotes the complex unit. If we apply the Fourier transform to the PDE (6), we get
∂ û
1
= − σ 2 k 2 û + ikρû − (r + λB + λC )û − fˆ = g(k)û − fˆ,
∂τ
2
where we denoted

(9)

1
g(k) = − σ 2 k 2 + ikρ − (r + λB + λC ).
2

We introduce ĥ(τ, k) = e−g(k)τ û(τ, k) to transform (9) to the ODE
∂ ĥ
= −e−g(k)τ fˆ
∂τ
that can be solved directly
ĥ(τ, k) = −

τ

Z

e−g(k)s fˆ(s, k) ds.

0

Hence, the solution of (9) has the form
û(τ, k) = −

Z

τ

eg(k)(τ −s) fˆ(s, k) ds

0

and we can apply the inverse Fourier transform to obtain the solution of the original equation (6)
Z ∞
1
−1
u(τ, x) = F [û(τ, k)] =
û(τ, k)eikx dk
2π −∞

Z τ
Z ∞
1
ikx
(− 21 σ2 k2 +ikρ−(r+λB +λC ))(τ −s) ˆ
f (s, k) ds dk.
(10)
=−
e
e
2π −∞
0
To show that two different forms (8) and (10) of the solution are equivalent one may use for
example similar techniques as Baustian, Mrázek, Pospíšil, and Sobotka (2017).

3.2

Non-negative payoffs

Many derivative contracts like call options have a non-negative payoff resulting in a non-negative
risk-less price v of the derivative, i.e., we have v = v + and v − = 0. If we consider un-collateralized
contracts or one-way CSA for such derivatives, as described in Section 2, then the term f for the
value adjustments simplifies to f (v) = (λC (1 − RC ) + λB (1 − RB ))v and we can represent the
correction u in dependence of the risk-less price v. We get

∂u
1 ∂ 2u
∂u

= σ2 2 + ρ
− (r + λB + λC )u − cf v,
for τ ∈ (0, T ], x ∈ R,
(11)
∂τ
2 ∂x
∂x

u(0, x) = 0,
for x ∈ R.
6

with cf = (λC (1 − RC ) + λB (1 − RB )) and recall that v satisfies the Black-Scholes equation

∂v
∂u
1 ∂2u

= σ2 2 + ρ
− rv,
for τ ∈ (0, T ], x ∈ R,
∂τ
2 ∂x
∂x

v(0, x) = h(x),
for x ∈ R,
where h(x) ≥ 0 is the payoff function of the derivative. We observe that the function
solution of (11) but has the non-trivial initial value


−cf v
−cf
(0, x) =
h(x).
λB + λC
λB + λC

−cf v
λB +λC

is a

Fortunately, we can make use of the function w = e−(λB +λC )τ v that satisfies w(0, x) = h(x) and
∂w
1 ∂2w
∂w
= σ2 2 + ρ
− (r + λB + λC )w
∂τ
2 ∂x
∂x
to obtain the solution
u(τ, x) =


λC (1 − RC ) + λB (1 − RB )  −(λB +λC )τ
cf
e
− 1 v(τ, x)
(w(τ, x) − v(τ, x)) =
λB + λC
λB + λC

of the initial value problem (11) with trivial initial data. We can use this representation of the
solution with any solution formula for v like the Black-Scholes formula or a Fourier transform
based formula to directly derive the correction term u.

3.3

Boundary conditions

Both problems (1) and (6) are defined either on a half-line in S or a line in x, respectively. However,
if we want to compare the numerical solution of the problem (6) with the solution provided by
MC or formula (8), we must reduce ourselves to a finite interval in x. In such case, we need to
define boundary conditions.
The PDE in (1) is a good starting point here, rather than the PDE in (6). Let us assume that
we work on the finite interval [0, Smax ] with Smax ∈ R+ sufficiently large. If we set S = 0, the
PDE in (1) reduces to
∂U
= (r + λB + λC ) * U + λB * εh ,
∂t
which can be solved to get


λB εh
U (t, 0) =
e(r+λB +λC )(t−T ) − 1 .
(12)
r + λB + λC
Hence, we have this Dirichlet boundary condition on the left for the PDE in (1).
Now, if we divide the PDE in (1) by S 2 and approach the limit S → +∞, we get
∂2U
(t, S) = 0.
S→+∞ ∂S 2
lim

We are actually assuming here some behaviour of U (t, S) as S → +∞. More precisely, the
growth of U (t, S) in S should be sub-quadratic for large S. In pricing equations for V , a common
approach is to consider the so-called zero gamma condition (in't Hout, 2017, Sec. 2.3), i.e.,
∂2V
(t, Smax ) = 0,
∂S 2

0 ≤ t ≤ T,

and hence it is natural to assume the same type of condition for the correction U
∂2U
(t, Smax ) = 0,
∂S 2
7

0 ≤ t ≤ T,

(13)

for some sufficiently large Smax . This approach was also already used, e.g., by Castillo, Ferreiro,
García-Rodríguez, and Vázquez (2013) and Arregui, Salvador, and Vázquez (2017). It is possible
to assume here U (t, Smax ) = c0 (t) + c1 (t)S as it was done in these papers, substitute it into (1)
and compute c0 , c1 either numerically or in some cases also analytically. However, we will stick
with (13) as our boundary condition. It is easier to implement, does not require any additional
lengthy computations and most importantly it provides us with significantly better results, when
comparing the numerical solution of the PDE to Monte-Carlo (MC) or formula (8).
Let us consider two numbers xmin , xmax ∈ R such that
−∞ < xmin < 0 < xmax < +∞.
Due to the transformation (5) and derived boundary conditions (12),(13), it seems reasonable to
consider boundary conditions
u(τ, xmin ) =
∂2u
(τ, xmax ) =
∂x2



λB εh
e−(r+λB +λC )τ − 1 ,
r + λB + λC
0,

for all τ ∈ [0, T ] completing the problem (6).

3.4

Numerical solution using finite differences

The goal of this subsection is to introduce the approximate scheme for the transformed problem
(6) completed by boundary conditions (14),(15). We intend to use the idea of the method of lines,
i.e., a separate discretization in time τ and space x (see, e.g., (LeVeque, 2007, Chapter 13)). The
whole problem is implemented in the software MATLAB, which possesses several useful solvers for
the evolution in time. Hence, we will approximate the spatial part of the problem (6),(14),(15),
which results in the system of ODEs. Then we will use a suitable ODE solver in MATLAB to
iterate it in time. The PDE of the problem (6) is typical advection–diffusion–reaction equation.
Since the problem is situated in one spatial dimension, it is sufficient to use finite differences.
As we mentioned in the previous subsection, we work on the interval [xmin , xmax ] in x. Let
us discretize this interval by the uniform grid with constant step size δ = xi+1 − xi for i =
0, 1, . . . , Nx − 1, hence, there is x0 = xmin and xNx = xmax . We denote the approximate value of
u(τ, xi ) by Ui and the value of f (V (τ, xi )) by Fi .
We acknowledge that it is quite common to use a non-uniform grid in x as was presented in
other works, e.g., (Rouah, 2013, Chap. 10) or (in't Hout, 2017, Sec. 4.2), where the mapping
function can be for example hyperbolic sine. One can then use very rough grid while maintaining
reasonable density of points around the strike, where the solution changes most significantly. This
approach can be useful if one aims to make large amount of numerical experiments (for different
parameters of the model for example) with low computation cost. However, if we look at our
problem from the point of view of numerical mathematics, the solution of (6) (see Figure 1) does
not include any dramatic oscillations or boundary layers. Hence, we can achieve a reasonable
solution with relatively rough uniform grid. Since our goal in this paper is to compare different
approaches of solving the problem (6), e.g., for different step sizes δ, using the non-uniform grid
is not necessary or even desirable.
We approximate derivatives in (6) by
Ui−1 − 2Ui + Ui+1
∂2u
(τ, xi ) ≈
∂x2
δ2

and

∂u
Ui+1 − Ui−1
(τ, xi ) ≈
∂x
2δ

for every i = 1, . . . , Nx − 1. Both of these differences are central with the error O(δ 2 ). Let
us mention here that since our problem is diffusion–dominated, the first order central difference
approximating the advection term does not bring in any oscillations and thus no stabilization is
necessary.
8

0

2

1.5
-50

1
-100
0.5

-150

0

Figure 1: Example of the solution computed by finite differences. The first picture contains the
3D plot of the solution in (x, τ ). Contours of the solution for different values of τ are depicted on
the right. The plotted solution was computed for the case xmin = −4, xmax = 8, and the strike
K = 15 (the other parameters are stated in the next section).
To deal with the boundary condition (15) at xmax , we employ the classical idea of a ghost
point, i.e., we consider the point xNx +1 = xNx + δ outside of the grid. With this point, we can
approximate the second derivative in (15) again by the second order central difference, which yields
UNx −1 − 2UNx + UNx +1
= 0.
δ2

(16)

Hence, we have the system of ODEs
∂Ui
Ui+1 − Ui−1
1
Ui−1 − 2Ui + Ui+1
+ρ*
= σ2 *
−(r+λB +λC )*Ui −Fi , for i = 1, . . . , Nx −1. (17)
∂τ
2
δ2
2δ
The equation (17) for i = Nx contains the value UNx +1 outside of the grid, i.e., the value at the
ghost point. Expressing UNx +1 from (16) and substituting it into (17) for i = Nx give us the
equation
UNx − UNx −1
∂UNx
(18)
=ρ*
− (r + λB + λC ) * UNx − FNx ,
∂τ
δ
for the computation of the value UNx at the boundary xmax .
We are using MATLAB's ode15s solver for the evolution of (17), (18) in time. It is known that
if the coefficient in front of the second derivative in (6) is small, the problem could be stiff. Hence,
it is safer option to use ode15s, which is built to deal with stiff problems, rather than ode45.
There are of course other options for the evolution in time, for example methods of ADI type like
Douglas method - see, e.g., (Rouah, 2013, Chap. 10) or (in't Hout, 2017, Chap. 13). This type
of methods is often used for problems in multiple spatial dimensions. Despite the fact, that our
problem is in one spatial dimension, we could use ADI method to split the iterative process into
three stages, the advection part, the diffusion part and the source part. This approach is very
viable and would be better than for example Euler's method, lowering the restriction of the CFL
condition. However, ode15s solver is adaptive in time and very capable of dealing with this kind
of problems, as well.

3.5

Numerical solution using the transformation to heat equation

In order to evaluate the double integral in (8) numerically, a suitable quadrature has to be chosen.
Although there exist many sophisticated quadratures, see for example monographs by Krylov
(1962); Stoer and Bulirsch (2002); Davis and Rabinowitz (2007); Dahlquist and Åke (2008), for
9

the clarity of our numerical comparison we use the simple trapezoid method. Let us consider an
equidistant partition of the interval [0, τ ]
si = i * δs ,

i = 0, 1, . . . , Ns

for given δs ∈ R and Ns ∈ N such that Ns * δs = τ . The inner integral needs to be restricted to a
bounded interval in order for the trapezoid method to be applicable. Let ymax > 0 be sufficiently
large number which shall be specified in the forthcoming sections and let δy ∈ R and Ny ∈ N be
such that Ny * δy = 2ymax . We then define the partition of the interval [−ymax , ymax ] as
yi = −ymax + i * δy ,

i = 0, 1, . . . , Ny .

We can now express the trapezoid value as
y −1
Ns −1 NX
1 X
UHE (τ, x) = − √
(g(si+1 , yi+1 ) − g(si , yi )) δy δs ,
4 π i=0 j=0

(19)

in which
g(s, y) = g(s, y; τ, x) = e−y

3.6

2

−(r+λB +λC )(τ −s)

f (V (s, x + ρτ +

p
2(τ − s)ρy)).

Numerical solution using the Monte-Carlo method

Currently, the most widely used method to evaluate the formula (4) with the subsequent expressions is the Monte-Carlo simulation. The incorporation of a change of variables and the
simplification of the term Dr̂ (t, u) in (4) results in
Z T
U∗ (t, S) = −
e(r+λB +λC )(u−t) E[f∗ (V (u, S(u))) | S(t) = S] du,
t

=−

Z

T −t

0

e(r+λB +λC )s E[f∗ (V (t + y, S(t + y))) | S(t) = S] ds,

in which ∗ ∈ { CVA, DVA, FCA, COLVA } and S(t) is modelled as the geometric Brownian
motion. After the change of variables (5) we get
Z τ
U∗ (τ, x) = −
e(r+λB +λC )s E[f∗ (V (T − τ + s, ln(S(T − τ + s)))) | ln(S(T − τ )) = x] ds. (20)
0

We shall compute the integral term in (20) again via the trapezoid method on the interval
[0, τ ] with partition
si = i * δs , i = 0, 1, . . . , Ns

with δs ∈ R, Ns ∈ N and δs * Ns = τ . The integral (20) can be now computed as
Û∗ (τ, x) = −

Ns −1
1 X
(g∗ (si+1 ) − g∗ (si ))δs
2 i=0

in which
g∗ (si ) := g∗ (si ; x) = e(r+λB +λC )s ε∗ (x),
where ε∗ (x) is the Monte-Carlo estimate of the corresponding conditional expectation. Finally
UMC (τ, x) = ÛCVA (τ, x) + ÛDVA (τ, x) + ÛFCA (τ, x) + ÛCOLVA (τ, x)

(21)

yields the numerically computed value of (4). In practice, ε∗ (x) is usually efficiently estimated
using the Quasi-Monte-Carlo method with low discrepancy Sobol sequences - see, e.g., Renzitti,
Bastani, and Sivorot (2020). The classical Monte-Carlo estimates will be calculated in the forthcoming section which is sufficient for the accuracy comparison purposes.
10

4

Numerical results

In this section we compare the pricing formula (8) with the Monte-Carlo pricing approach using
the formula (4) and a numerical solution of the PDE (6), namely with the solution obtained
using the finite differences method (FDM). Also, we distinguish two collateral strategies: the uncollateralized contract, X = 0, which leads to more intricate right source term of (1) compared
to other choices and the delayed collateral, X = V (t − t0 , S(t − t0 )). We do not consider one-way
CSA since the corresponding adjustments are quite similar to contracts with no collateral. We
recall that the different collaterals were discussed in Section 2.

4.1

Un-collateralized contract, X = 0

We fixed parameters σ = 0.25, qs = 0.03, γs = 0, r = 0.03, λB = 0.02, λC = 0.05, RB = 0.4,
RC = 0.4, sX = 0.012, X = 0, T = 2, εh as in (2) and we valued the European call option with
strike price K = 15.
For all the tests, we considered the pricing formula (8) to be the benchmark solution which we
computed with parameters δy = 2−3 , δs = 2−10 , ymax = 100. These parameters seem to be the
threshold ones such that finer discretization and larger integration region would not improve the
accuracy significantly.
The experiments pursued two main directions. First, we studied the behaviour of the finite
difference scheme in Section 3.4 while varying the spatial discretization δx , the temporal discretization δτ and the integration region [xmin , xmax ]. The second experiment is focused on the
Monte-Carlo formula (21) and its accuracy with respect to the number of simulated paths, denoted by N . In order to mitigate the approximative behaviour of the boundary condition (18)
and to eliminate the growing region size in the latter case we compare the values in the region
Ω = [ln(K) − 1, ln(K) + 1] × [0, τ ]. The error was quantified via the estimate of the Lmax norm,
i.e.,
kgkLmax = max {|g(i * δx , j * δs )| ; i = 0, 1, . . . , Nτ , j = 0, 1, . . . , Nx }
and the estimate of the L2 -norm
 12

NX
τ −1 N
x −1
X
kgkL2 = 
(g(xi+1 , τj+1 ) − g(xi , τj ))2 δx δτ  ,
i=0

j=0

While evaluating the performance of the finite difference scheme, we fixed −xmin = xmax = 5
and let δx = 2−2i , i = 1, . . . , 4, and δτ = 2−2j , j = 1, . . . , 5, vary. The results are depicted in
Figure 2 which show a good agreement of the two approaches. As can be seen, the error is almost
independent of the temporal discretization fineness which can be caused by the fact, that the
ode15s solver chooses the time step adaptively.
Next, we fixed δx = 2−6 , δτ = 2−3 , xmin = −4 and let xmax = 4, 5, . . . , 8, vary. We do not vary
xmin , because exmin = e−4 ≈ 0.018 is sufficiently close to zero and taking more negative xmin would
not provide much difference. As can be seen in Figure 3 the influence of the region truncation is
notable for extremely small regions exclusively. Further enlargement does not significantly improve
the accuracy.
Finally, we set δx = 2−1 , δτ = 2−2 , −xmin = xmax = 5 (note that these parameters influence
only the number of points we use to compute the error since only the schemes (19), (21) were
considered) and the Monte-Carlo time step δs = 2−10 . The dependence of the error of the MonteCarlo method on the number of simulated paths N = 103+0.5j , j = 0, . . . , 4 is depicted in Figure 4.

4.2

Collateral as the delayed value, X = V (t − t0 , S(t − t0 ))

Let us now consider the collateral to be the delayed value as in (3) where S(t − t0 ) is approximated
by its backward-discounted value, i.e.,
ff

1 2
S(t − t0 ) ≈ S(t) exp −t0 (qs − γs − σ ) .
2
11

10-3

10-3
L

12

L

12

L

11

L

max
2

max
2

10
9

Error

Error

10

8

8
7
6

6

5
4

4
3

2

2
10-2

10-1

10-3

10-2

10-1

x

Figure 2: Comparison of finite difference scheme (FD) (Section 3.4) and the heat equation formula
(HE) (Section 3.5). The left panel captures the situation with fixed δτ = 2−6 and the right panel
depicts the case with fixed δx = 2−6 .

L

0.016

L

max
2

0.014
0.012

Error

0.01
0.008
0.006
0.004
0.002
0
3

4

5

6

7

8

9

x max

Figure 3: Comparison of finite difference scheme (FD) (Section 3.4) and the heat equation formula
(HE) (Section 3.5) with δx = 2−6 , δτ = 2−3 and xmax variable.
When dealing with one underlying only, Monte-Carlo simulation can be performed using the
Brownian bridge pinned at t and t − t0 which leads to the same approximative underlying value
at t − t0 . Also, one needs to adjust the time discretization in the computation of the integral
appropriately for the partition points to hit exactly the past time t − t0 .
The model parameters are unchanged compared to the previous experiments except for sX =
0.02. This is a necessary adjustment. Indeed, if we denote X1 = V (t − t1 , S(t − t1 )), X2 =
V (t − t2 , S(t − t2 )) for any delay terms t1 , t2 ∈ R+
0 then since V − Xi ≤ 0 for i = 1, 2, the difference
of the right hand side of (1) can be expressed as
f1 − f2 = (−λB (1 − RB ) + sX )(X1 − X2 ).
If λB (1 − RB ) = sX the values of the same derivatives are equal regardless of the delay ti .
The delay term was set to be t0 = 1/252 (assuming 252 trading days per year). The difference
between the values of the derivatives with no delay (X = V ) and with delay (X = V (t − t0 , S(t −
t0 ))) is depicted in the left panel of Figure 5. Similar test in the virtue of Figure 4 for the heat
equation formulation and the Monte-Carlo simulation is show in the right panel of Figure 5.

12

0.1

L
L

max
2

0.08

Error

0.06

0.04

0.02

0

-0.02
103

104

105

N

Figure 4: Comparison of the Monte-Carlo solution (MC) (Section 3.6) and the heat equation
formula (HE) (Section 3.5) for variable number of simulated paths N .
2

0.05

-0.5

1.8

L
L

1.6
1.4

-1

0.04

-1.5

0.03

max
2

Error

1.2
-2

1
0.8

0.02

-2.5

0.01
0.6
-3

0.4

0
-3.5

0.2

-0.01

0
20

40

60

80

100

120

140

10

-5

103

S

104

105

N

Figure 5: Left panel: Contour plot of the difference of the valued of the European call option with
the undelayed collateral X = V and the previous-day delayed collateral X = V (t − t0 , S(t − t0 ))
with t0 = 1/252. Right panel: The comparison of the heat equation formula and the Monte-Carlo
simulation for the delayed collateral.

5

Conclusion

The aim of this paper was to bring attention to analytical solutions of the partial differential
equation used in value adjustment modelling. Although the PDE approach is known for more
than a decade (Burgard and Kjaer, 2011b), presented derivation of semi-closed formulas has not
been published until now. When dealing with one underlying asset only, we can easily apply the
transformation of the xVA PDE to the heat equation with known solution and hence obtain a
fast and reliable semi-closed pricing formula that confirmed to be consistent with the Monte-Carlo
simulations and with the numerical solution of the PDE obtained by the finite differences method.
A special attention was paid to the example with collateral taken as the value from the past,
typically one day back is considered in practice. As a further research it might be interesting to
study also what happens if the collateral is posted daily, weekly, monthly, etc. This however poses
new analytical and numerical challenges, since the inhomogeneity f is then discontinuous.
It is worth mentioning that xVA is often considered in a multi-dimensional setting, i.e., with
multiple risk factors whose driving Wiener processes are instantaneously correlated. Such a setting
then leads to a PDE with multiple spatial dimensions that could also be suited for transformation

13

to heat equation as presented in this paper. A detailed study of the multi-dimensional setting
was not in the scope of this paper but will be a subject of future research. Nevertheless, our
analytic approach still might be of practical interest in the sense that one may need to study the
valuation adjustment for each of the underlyings independently in order to identify their individual
contribution to the risk. In this case, an analytic formula is definitely much more convenient than
any Monte-Carlo simulation. On the other hand, calculating xVA for highly complex portfolio is
nowadays performed only by means of Monte-Carlo and Quasi-Monte-Carlo simulations.

Funding
The work was partially supported by the Czech Science Foundation (GAČR) grant no. GA1816680S "Rough models of fractional stochastic volatility".

Acknowledgements
Computational resources were supplied by the project "e-Infrastruktura CZ" (e-INFRA LM2018140)
provided within the program Projects of Large Research, Development and Innovations Infrastructures.

References
Arregui, I. n., Salvador, B., and Vázquez, C. (2017), CVA computing by PDE models. In Numerical analysis
and its applications, vol. 10187 of Lecture Notes in Comput. Sci., pp. 15–24, Cham: Springer, ISBN 978-3-31957099-0, DOI 10.1007/978-3-319-57099-0_2, Zbl 1367.91190, MR3661225.
Arregui, I. n., Salvador, B., Ševčovič, D., and Vázquez, C. (2018), Total value adjustments for European
options with two stochastic factors. mathematical model, analysis and numerical simulation. Comput. Math.
with Appl. 76(4), 725–740, ISSN 0898-1221, DOI 10.1016/j.camwa.2018.05.012, Zbl 1426.91261, MR3830757.
Baustian, F., Mrázek, M., Pospíšil, J., and Sobotka, T. (2017), Unifying pricing formula for several stochastic volatility models with jumps. Appl. Stoch. Models Bus. Ind. 33(4), 422–442, ISSN 1524-1904,
DOI 10.1002/asmb.2248, Zbl 1420.91444, MR3690484.
Black, F. and Scholes, M. (1973), The pricing of options and corporate liabilities. J. Polit. Econ. 81(3), 637–654,
ISSN 0022-3808, DOI 10.1086/260062, Zbl 1092.91524, MR3363443.
Burgard, C. and Kjaer, M. (2011a), In the balance. Risk 24, 72–75, DOI 10.2139/ssrn.1785262.
Burgard, C. and Kjaer, M. (2011b), Partial differential equation representations of derivatives with bilateral
counterparty risk and funding costs. J. Credit Risk 7(3), 75–93, DOI 10.21314/JCR.2011.131.
Burgard, C. and Kjaer, M. (2013), Funding costs, funding strategies. Risk 26, 82–87, DOI 10.2139/ssrn.2027195.
Castillo, D., Ferreiro, A. M., García-Rodríguez, J. A., and Vázquez, C. (2013), Numerical methods to
solve PDE models for pricing business companies in different regimes and implementation in GPUs. Appl. Math.
Comput. 219(24), 11233–11257, ISSN 0096-3003, DOI 10.1016/j.amc.2013.05.032, Zbl 1304.65186, MR3073276.
Dahlquist, G. and Åke, B. (2008), Numerical methods in scientific computing. Vol. I. Society for Industrial
and Applied Mathematics (SIAM), Philadelphia, PA, ISBN 978-0-898716-44-3, DOI 10.1137/1.9780898717785,
MR2412832.
Davis, P. J. and Rabinowitz, P. (2007), Methods of numerical integration. Dover Publications, Inc., Mineola,
NY, ISBN 978-0-486-45339-2, corrected reprint of the second (1984) edition, Zbl 1139.65016, MR2401585.
Duffie, D. and Huang, M. (1996), Swap rates and credit quality. J. Finance 51(3), 921–949, ISSN 1540-6261,
DOI 10.2307/2329227.
Evans, L. C. (2010), Partial differential equations, vol. 19 of Graduate Studies in Mathematics. American Mathematical Society, Providence, RI, second edn., ISBN 978-0-8218-4974-3, DOI 10.1090/gsm/019, Zbl 1194.35001,
MR2597943.
Gregory, J. (2020), The xVA Challenge: counterparty credit risk, funding, collateral and capital. Wiley Finance,
Chichester, West Sussex, UK: John Wiley & Sons, 4th edn., ISBN 978-1-119-50897-7/hbk, 978-1-119-50900-4/ebook.
Heston, S. L. (1993), A closed-form solution for options with stochastic volatility with applications to bond and
currency options. Rev. Financ. Stud. 6(2), 327–343, ISSN 0893-9454, DOI 10.1093/rfs/6.2.327, Zbl 1384.35131,
MR3929676.
Hull, J. and White, A. (2012), The FVA debate. Risk 25, 83–85.
Hull, J. and White, A. (2014), Valuing derivatives: Funding value adjustments and fair value. Financial Anal.
J. 70(3), 45–56, DOI 10.2469/faj.v70.n3.3.

14

Hull, J. C. (2009), Options, Futures, and Other Derivatives. Prentice Hall, 7th edn., ISBN 978-0-13-601586-4/hbk.
Hull, J. C. (2018), Risk Management and Financial Institutions. Wiley Finance, Wiley, 5th edn., ISBN 978-1119-44811-2/hbk, 978-1-119-44809-9/e-book.
Hull, J. C. and White, A. D. (1987), The pricing of options on assets with stochastic volatilities. J. Finance
42(2), 281–300, ISSN 1540-6261, DOI 10.1111/j.1540-6261.1987.tb02568.x.
in't Hout, K. (2017), Numerical Partial Differential Equations in Finance Explained. An Introduction to Computational Finance. Financial Engineering Explained, London, UK: Palgrave Macmillan, ISBN 978-1-137-435682/hbk; 978-1-349-95381-3/pbk; 978-1-137-43569-9/ebook, DOI 10.1057/978-1-137-43569-9.
Jarrow, R. A. and Turnbull, S. M. (1995), Pricing options on financial securities subject to credit risk. J.
Finance 50(1), 53–85, ISSN 1540-6261, DOI 10.2307/2329239.
Krylov, V. I. (1962), Approximate calculation of integrals. Translated by Arthur H. Stroud, The Macmillan Co.,
New York-London, 1962, Zbl 1152.65005, MR0144464.
LeVeque, R. J. (2007), Finite difference methods for ordinary and partial differential equations. Steady-state
and time-dependent problems. Philadelphia, PA: Society for Industrial and Applied Mathematics (SIAM), ISBN
978-0-898716-29-0/pbk, DOI 10.1137/1.9780898717839, Zbl 1127.65080, MR2378550.
Merton, R. C. (1973), Theory of rational option pricing. Bell J. Econ. 4(1), 141–183, ISSN 0005-8556,
DOI 10.2307/3003143, Zbl 1257.91043, MR0496534.
Piterbarg, V. (2010), Funding beyond discounting: collateral agreements and derivatives pricing. Risk 23, 97–102.
Renzitti, S., Bastani, P., and Sivorot, S. (2020), Accelerating CVA and CVA Sensitivities Using Quasi-Monte
Carlo Methods. Wilmott 2020(108), 78–93, DOI 10.1002/wilm.10860.
Rouah, F. D. (2013), The Heston Model and its Extensions in Matlab and C#, + Website. Wiley Finance Series,
Hoboken, NJ: John Wiley & Sons, Inc., ISBN 978-1-118-54825-7/pbk; 978-1-118-65647-1/ebook, Zbl 1304.91007.
Rubinstein, M. (1985), Nonparametric tests of alternative option pricing models using all reported trades and
quotes on the 30 most active CBOE classes from august 23, 1976 through august 31, 1978. J. Finance 40(2),
455–480, DOI 10.1111/j.1540-6261.1985.tb04967.x.
Rubinstein,
M.
(1994),
Implied
binomial
trees.
J.
Finance
49(3),
771–818,
DOI 10.1111/j.1540-6261.1994.tb00079.x.
Salvador, B. and Oosterlee, C. W. (2021), Total value adjustment for a stochastic volatility model.
A comparison with the Black-Scholes model. Appl. Math. Comput. 391, 125489, 19, ISSN 0096-3003,
DOI 10.1016/j.amc.2020.125489, MR4149125.
Sorenson, E. H. and Bollier, T. F. (1994), Pricing swap default risk. Financial Anal. J. 50(3), 23–33, ISSN
0015-198X, DOI 10.2469/faj.v50.n3.23.
Stein, E. M. and Stein, J. C. (1991), Stock price distributions with stochastic volatility: An analytic approach.
Rev. Financ. Stud. 4(4), 727–752, ISSN 0893-9454, DOI 10.1093/rfs/4.4.727, Zbl 06857133.
Stoer, J. and Bulirsch, R. (2002), Introduction to numerical analysis, vol. 12 of Texts in Applied Mathematics.
Springer-Verlag, New York, third edn., ISBN 0-387-95452-X, DOI 10.1007/978-0-387-21738-3, Zbl 1004.65001,
MR1923481.

15

